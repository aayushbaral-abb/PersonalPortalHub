<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aayush Baral-Portal Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #c3cdd6; }
        .card { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .tab-button.active { border-bottom: 2px solid #3b82f6; font-weight: 600; color: #3b82f6; }
        /* Style for file and link list items */
        .file-item-container, .link-item-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            transition: all 0.3s;
        }
        .file-item-container:hover, .link-item-container:hover {
            border-color: #3b82f6;
        }
        .file-info, .link-info {
            flex-grow: 1;
            min-width: 0;
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app-container" class="w-full max-w-xl">

        <div id="password-form-card" class="card bg-white p-8 rounded-xl">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">üîêPersonal Portal Hub</h2>
            <form id="access-form">
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-2 text-center">
                        Don't Access without authorization of Mr.Aayush Baral!
                    </label>
                    <input type="password" id="password" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                           placeholder="Enter your password">
                </div>
                <div id="message" class="text-sm text-center font-medium mb-4 h-5"></div>
                <button type="submit" id="submit-button"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition duration-200 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50">
                    Access Portal Hub
                </button>
            </form>
        </div>

        <div id="content-card" class="card bg-white p-8 rounded-xl hidden">
            <h2 class="text-3xl font-bold text-green-700 mb-6 text-center">Welcome Back! <br> Mr.Aayush</h2>

            <div class="flex border-b border-gray-200 mb-6">
                <button data-tab="links" class="tab-button active flex-1 py-3 text-gray-500 hover:text-blue-500 transition duration-150">
                    üîó Links (View)
                </button>
                <button data-tab="add-links" class="tab-button flex-1 py-3 text-gray-500 hover:text-blue-500 transition duration-150">
                    ‚ûï Add Link
                </button>
                <button data-tab="documents" class="tab-button flex-1 py-3 text-gray-500 hover:text-blue-500 transition duration-150">
                    üìÅ Documents
                </button>
                <button data-tab="memo" class="tab-button flex-1 py-3 text-gray-500 hover:text-blue-500 transition duration-150">
                    üìù Memo
                </button>
            </div>

            <div id="links-content" class="tab-content">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Saved Links</h3>
                <div id="link-list" class="space-y-3">
                    </div>
            </div>

            <div id="add-links-content" class="tab-content hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Add New Link</h3>
                <div class="space-y-4">
                    <div>
                        <label for="link-title" class="block text-sm font-medium text-gray-700">Link Title</label>
                        <input type="text" id="link-title" required 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="link-url" class="block text-sm font-medium text-gray-700">Link URL</label>
                        <input type="url" id="link-url" required placeholder="https://..." 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button id="add-link-button"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 rounded-lg transition duration-200">
                        Add Link
                    </button>
                    <div id="links-add-message" class="text-sm text-center font-medium mt-2 h-5"></div>
                </div>
            </div>
            
            <div id="documents-content" class="tab-content hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Your Files</h3>
                
                <div class="p-4 bg-gray-50 border border-dashed border-gray-300 rounded-lg mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Upload Document (Max 50MB)</label>
                    <input type="file" id="file-input"> 
                    <button id="upload-button" 
                            class="mt-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 focus:outline-none disabled:bg-gray-400">
                        Upload File
                    </button>
                    <div id="upload-message" class="text-sm mt-2"></div>
                </div>

                <div id="document-list" class="space-y-3">
                    </div>
            </div>

            <div id="memo-content" class="tab-content hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Personal Quick Memo</h3>
                <textarea id="personal-memo" rows="7" placeholder="Write your short, important notes here..."
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"></textarea>
                <button id="save-memo-button"
                        class="mt-3 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded-lg transition duration-200 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
                    Save Memo
                </button>
                <div id="memo-message" class="text-sm text-center font-medium mt-2 h-5 text-gray-500"></div>
            </div>

            <button onclick="window.location.reload()"
                    class="mt-8 w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 rounded-lg transition duration-200 focus:outline-none focus:ring-4 focus:ring-gray-500 focus:ring-opacity-50">
                Log Out / Close
            </button>
        </div>

    </div>

    <script>
        const SUPABASE_URL = 'https://razynxtpstphzgjpxqmb.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJhenlueHRwc3RwaHpnanB4cW1iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1ODgwMTIsImV4cCI6MjA4MDE2NDAxMn0.ub5cYcn5g6Mm3OtnmarNW1rQ0Njxss_syqJiTiBrrDo';
        const BUCKET_NAME = 'documents'; 

        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // --- HTML Elements ---
        const passwordInput = document.getElementById('password');
        const messageElement = document.getElementById('message');
        const submitButton = document.getElementById('submit-button');
        const formCard = document.getElementById('password-form-card');
        const contentCard = document.getElementById('content-card');
        
        // Tab elements
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        // Content elements
        const linkList = document.getElementById('link-list');
        const documentList = document.getElementById('document-list');
        const personalMemoTextarea = document.getElementById('personal-memo');
        const saveMemoButton = document.getElementById('save-memo-button');
        const memoMessageElement = document.getElementById('memo-message');

        // Link Management Elements
        const linkTitleInput = document.getElementById('link-title');
        const linkUrlInput = document.getElementById('link-url');
        const addLinkButton = document.getElementById('add-link-button');
        const linksAddMessageElement = document.getElementById('links-add-message');


        // Upload elements
        const fileInput = document.getElementById('file-input');
        const uploadButton = document.getElementById('upload-button');
        const uploadMessage = document.getElementById('upload-message');
        
        // --- State Variables ---
        let credentialId = null; 

        // --- Core Authentication Logic ---
        document.getElementById('access-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = passwordInput.value.trim();
            if (password.length === 0) { showMessage("Please enter the access key.", 'text-red-500'); return; }

            setLoading(true);

            // 1. Secure RPC Call for verification
            const { data, error } = await supabaseClient
                .rpc('verify_portal_access', { input_key: password })
                .select('id') // Only select the ID
                .single(); 

            setLoading(false);

            if (error && error.code !== 'PGRST116') {
                console.error('Supabase Query Error:', error);
                showMessage("An error occurred. Please try again.", 'text-red-500');
            } else if (data) {
                // 2. Authentication Successful
                credentialId = data.id; // Store the UUID
                showMessage("Access granted!", 'text-green-500');
                
                // Initialize all content upon successful login
                await fetchLinks(); 
                await fetchFiles(); 
                await fetchMemo(); 
                
                formCard.classList.add('hidden');
                contentCard.classList.remove('hidden');

            } else {
                // 3. Authentication Failed
                showMessage("Invalid Password. Please try again.", 'text-red-500');
                passwordInput.value = "";
            }
        });

        // --- Tab Switching Logic ---
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.dataset.tab;

                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                tabContents.forEach(content => content.classList.add('hidden'));
                document.getElementById(`${targetTab}-content`).classList.remove('hidden');
            });
        });


        // --- LINK SECTION (Multiple Links) ---
        
        // Fetch and display all saved links
        async function fetchLinks() {
            linkList.innerHTML = '<p class="text-center text-gray-500">Loading links...</p>';

            const { data, error } = await supabaseClient
                .from('user_links')
                .select('*')
                .eq('credential_id', credentialId)
                .order('created_at', { ascending: true });

            if (error) {
                console.error('Error fetching links:', error);
                linkList.innerHTML = '<p class="text-center text-red-500">Error loading links.</p>';
                return;
            }

            if (data.length === 0) {
                linkList.innerHTML = '<p class="text-center text-gray-500">No links saved yet. Use the "Add Link" tab to start.</p>';
                return;
            }

            linkList.innerHTML = '';
            data.forEach(link => {
                const container = document.createElement('div');
                container.className = 'link-item-container';
                
                const linkItem = document.createElement('a');
                linkItem.href = link.url;
                linkItem.target = "_blank"; 
                linkItem.className = 'link-info flex-1 min-w-0';
                linkItem.innerHTML = `
                    <span class="text-xl mr-3">üîó</span>
                    <div class="min-w-0">
                        <h4 class="text-lg font-semibold text-gray-800 truncate">${link.title}</h4>
                        <p class="text-sm text-gray-500 truncate">${link.url}</p>
                    </div>
                `;
                container.appendChild(linkItem);

                // Delete Button for Links
                const deleteButton = document.createElement('button');
                deleteButton.dataset.linkId = link.id;
                deleteButton.className = 'delete-link-button ml-4 text-red-500 hover:text-red-700 p-2 rounded-full transition duration-150';
                deleteButton.innerHTML = 'üóëÔ∏è';
                container.appendChild(deleteButton);

                linkList.appendChild(container);
            });
            
            // Attach event listeners for delete buttons
            document.querySelectorAll('.delete-link-button').forEach(button => {
                button.addEventListener('click', handleDeleteLink);
            });
        }

        // Add New Link Logic
        addLinkButton.addEventListener('click', async () => {
            const title = linkTitleInput.value.trim();
            const url = linkUrlInput.value.trim();

            if (!title || !url) {
                showLinksAddMessage('Title and URL are required.', 'text-red-500');
                return;
            }

            addLinkButton.disabled = true;
            addLinkButton.textContent = 'Adding...';

            const { error } = await supabaseClient
                .from('user_links')
                .insert([
                    { credential_id: credentialId, title: title, url: url }
                ]);

            addLinkButton.disabled = false;
            addLinkButton.textContent = 'Add Link';

            if (error) {
                console.error('Add Link Error:', error);
                showLinksAddMessage(`Error adding link: ${error.message}`, 'text-red-500');
            } else {
                showLinksAddMessage('Link added successfully!', 'text-green-600');
                linkTitleInput.value = '';
                linkUrlInput.value = '';
                fetchLinks(); // Refresh the link list
            }
        });

        // Delete Link Function
        async function handleDeleteLink(e) {
            e.preventDefault();
            e.stopPropagation();

            const button = e.currentTarget;
            const linkId = button.dataset.linkId;
            
            if (!confirm(`Are you sure you want to delete this link?`)) {
                return;
            }

            button.disabled = true;
            button.innerHTML = '...';

            const { error: dbError } = await supabaseClient
                .from('user_links')
                .delete()
                .eq('id', linkId);

            if (dbError) {
                console.error('Link Deletion Error:', dbError);
                alert(`Error deleting link: ${dbError.message}`);
                button.disabled = false;
                button.innerHTML = 'üóëÔ∏è';
            } else {
                fetchLinks(); // Refresh the link list
            }
        }


        // --- DOCUMENT SECTION (Read/Write/Delete) ---

        // Fetch all previously uploaded files
        async function fetchFiles() {
            documentList.innerHTML = '<p class="text-center text-gray-500">Loading documents...</p>';

            const { data, error } = await supabaseClient
                .from('user_files')
                .select('*')
                .eq('credential_id', credentialId)
                .order('uploaded_at', { ascending: false });

            if (error) {
                console.error('Error fetching files:', error);
                documentList.innerHTML = '<p class="text-center text-red-500">Error loading documents.</p>';
                return;
            }

            if (data.length === 0) {
                documentList.innerHTML = '<p class="text-center text-gray-500">No documents uploaded yet.</p>';
                return;
            }

            documentList.innerHTML = '';
            data.forEach(file => {
                const fileItemLink = document.createElement('a');
                
                // --- FILE NAME DISPLAY (Now clean due to upload fix) ---
                const displayFileName = file.file_name; 
                // -----------------------------------------------------------

                const { data: publicUrlData } = supabaseClient
                    .storage
                    .from(BUCKET_NAME)
                    .getPublicUrl(file.file_url);

                const icon = getFileIcon(displayFileName); 
                
                // Set link attributes
                fileItemLink.href = publicUrlData.publicUrl;
                fileItemLink.target = "_blank";
                fileItemLink.download = displayFileName; // <--- The download uses the clean name
                
                fileItemLink.className = 'file-info flex-1'; 
                fileItemLink.innerHTML = `
                    <span class="text-xl mr-3">${icon}</span>
                    <div class="min-w-0">
                        <h4 class="text-lg font-semibold text-gray-800 truncate">${displayFileName}</h4>
                        <p class="text-sm text-gray-500">${new Date(file.uploaded_at).toLocaleDateString()}</p>
                    </div>
                `;

                const container = document.createElement('div');
                container.className = 'file-item-container';
                container.appendChild(fileItemLink);

                // Delete Button
                const deleteButton = document.createElement('button');
                deleteButton.dataset.fileId = file.id;
                deleteButton.dataset.filePath = file.file_url;
                deleteButton.className = 'delete-file-button ml-4 text-red-500 hover:text-red-700 p-2 rounded-full transition duration-150';
                deleteButton.innerHTML = 'üóëÔ∏è';
                container.appendChild(deleteButton);

                documentList.appendChild(container);
            });
            
            // Attach event listeners for delete buttons
            document.querySelectorAll('.delete-file-button').forEach(button => {
                button.addEventListener('click', handleDeleteFile);
            });
        }

        // Document Delete Logic
        async function handleDeleteFile(e) {
            e.preventDefault();
            e.stopPropagation(); 

            const button = e.currentTarget;
            const fileId = button.dataset.fileId;
            const filePath = button.dataset.filePath;
            
            if (!confirm(`Are you sure you want to delete the file? This action is permanent and removes the file from storage.`)) {
                return;
            }

            button.disabled = true;
            button.innerHTML = '...';

            // 1. Delete the file from Supabase Storage
            const { error: storageError } = await supabaseClient.storage
                .from(BUCKET_NAME)
                .remove([filePath]);

            if (storageError) {
                console.error('Storage Deletion Error:', storageError);
                alert(`Error deleting file from storage: ${storageError.message}`);
                button.disabled = false;
                button.innerHTML = 'üóëÔ∏è';
                return;
            }

            // 2. Delete the record from the user_files table
            const { error: dbError } = await supabaseClient
                .from('user_files')
                .delete()
                .eq('id', fileId);

            if (dbError) {
                console.error('DB Deletion Error:', dbError);
                alert(`Error deleting record from database: ${dbError.message}`);
            } else {
                alert('File deleted successfully!');
                fetchFiles(); // Refresh the list
            }
        }


        // Handle file upload
        uploadButton.addEventListener('click', async () => {
            const file = fileInput.files[0];
            if (!file) {
                showUploadMessage('Please select a file first.', 'text-red-500');
                return;
            }

            const MAX_FILE_SIZE_BYTES = 52428800; // 50 MB

            if (file.size > MAX_FILE_SIZE_BYTES) { 
                showUploadMessage('File is too large (max 50MB).', 'text-red-500');
                return;
            }

            uploadButton.disabled = true;
            uploadButton.textContent = 'Uploading...';
            showUploadMessage('Starting upload...', 'text-blue-500');

            // --- DEFINITIVE FILE NAME FIX ---
            // 1. Use the original file name (NO TIMESTAMP)
            const originalFileName = file.name;
            
            // 2. Use the UUID as the folder path for unique file storage
            // This prevents overwriting other users' files with the same name.
            const filePath = `${credentialId}/${originalFileName}`;
            // --------------------------------

            // 1. Upload to Supabase Storage
            const { error: uploadError } = await supabaseClient.storage
                .from(BUCKET_NAME)
                .upload(filePath, file);

            if (uploadError) {
                console.error('Upload Error:', uploadError);
                showUploadMessage(`Upload failed: ${uploadError.message}`, 'text-red-500');
                uploadButton.disabled = false;
                uploadButton.textContent = 'Upload File';
                return;
            }

            // 2. Record file metadata in the 'user_files' table
            const { error: dbError } = await supabaseClient
                .from('user_files')
                .insert([
                    { 
                        credential_id: credentialId, 
                        file_name: originalFileName, // Save the CLEAN name
                        file_url: filePath,
                        mime_type: file.type
                    }
                ]);

            uploadButton.disabled = false;
            uploadButton.textContent = 'Upload File';
            fileInput.value = ''; // Clear file input

            if (dbError) {
                console.error('DB Record Error:', dbError);
                showUploadMessage('File uploaded, but database record failed.', 'text-orange-500');
            } else {
                showUploadMessage('File uploaded and saved successfully!', 'text-green-600');
                fetchFiles(); // Refresh the list
            }
        });

        // Helper function for file icons
        function getFileIcon(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            switch (ext) {
                case 'pdf': return 'üìÑ';
                case 'doc':
                case 'docx': return 'üìù';
                case 'xls':
                case 'xlsx': return 'üìä';
                case 'jpg':
                case 'jpeg':
                case 'png': return 'üñºÔ∏è';
                case 'zip':
                case 'rar': return 'üì¶';
                default: return '‚ùì';
            }
        }
        
        // --- MEMO SECTION (Read/Write) ---

        // Fetch the saved memo
        async function fetchMemo() {
            personalMemoTextarea.value = 'Loading your private memo...';
            const { data, error } = await supabaseClient
                .from('user_memo')
                .select('memo_content')
                .eq('credential_id', credentialId)
                .single();

            if (error && error.code !== 'PGRST116') {
                console.error('Fetch Memo Error:', error);
                personalMemoTextarea.value = 'Error loading memo.';
            } else if (data) {
                personalMemoTextarea.value = data.memo_content || '';
            } else {
                personalMemoTextarea.value = ''; 
                showMemoMessage("No previous memo found. Write and save one!", 'text-gray-500');
            }
        }

        // Save (Upsert) the memo
        saveMemoButton.addEventListener('click', async () => {
            saveMemoButton.disabled = true;
            saveMemoButton.textContent = 'Saving...';
            showMemoMessage('Saving memo...', 'text-blue-500');
            
            // Upsert (Insert or Update) based on credential_id
            const { error } = await supabaseClient
                .from('user_memo')
                .upsert(
                    { credential_id: credentialId, memo_content: personalMemoTextarea.value }, 
                    { onConflict: 'credential_id' }
                );

            saveMemoButton.disabled = false;
            saveMemoButton.textContent = 'Save Memo';

            if (error) {
                console.error('Save Memo Error:', error);
                showMemoMessage('Failed to save memo!', 'text-red-500');
            } else {
                showMemoMessage('Memo saved successfully!', 'text-green-600');
            }
        });
        
        // --- General Helper Functions ---
        function setLoading(isLoading) {
            submitButton.disabled = isLoading;
            submitButton.textContent = isLoading ? 'Checking Password...' : 'Access Portal';
        }

        function showMessage(text, colorClass) {
            messageElement.textContent = text;
            messageElement.className = `text-sm text-center font-medium mb-4 h-5 ${colorClass}`;
            setTimeout(() => { messageElement.textContent = ''; messageElement.className = 'text-sm text-center font-medium mb-4 h-5'; }, 3000);
        }

        function showMemoMessage(text, colorClass) {
            memoMessageElement.textContent = text;
            memoMessageElement.className = `text-sm text-center font-medium mt-2 h-5 ${colorClass}`;
            setTimeout(() => { memoMessageElement.textContent = ''; memoMessageElement.className = 'text-sm text-center font-medium mt-2 h-5 text-gray-500'; }, 3000);
        }

        function showUploadMessage(text, colorClass) {
            uploadMessage.textContent = text;
            uploadMessage.className = `text-sm mt-2 ${colorClass}`;
            setTimeout(() => { uploadMessage.textContent = ''; uploadMessage.className = 'text-sm mt-2'; }, 5000);
        }

        function showLinksAddMessage(text, colorClass) {
            linksAddMessageElement.textContent = text;
            linksAddMessageElement.className = `text-sm text-center font-medium mt-2 h-5 ${colorClass}`;
            setTimeout(() => { linksAddMessageElement.textContent = ''; linksAddMessageElement.className = 'text-sm text-center font-medium mt-2 h-5'; }, 3000);
        }

    </script>
</body>

</html>
