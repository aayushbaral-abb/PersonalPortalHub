<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Portal Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use the specific version of the Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .card { 
            background-color: white; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .nav-btn.active { border-bottom: 3px solid #10b981; color: #10b981; }
        input[type="file"]::file-selector-button {
            border: none;
            padding: 0.5rem 1rem;
            margin-right: 1rem;
            background-color: #f3f4f6;
            color: #374151;
            cursor: pointer;
            border-radius: 0.375rem;
            transition: background-color 0.15s ease-in-out;
        }
        input[type="file"]::file-selector-button:hover {
            background-color: #e5e7eb;
        }
        /* Custom scrollbar for memo list */
        .memo-scroll {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }
        .editable-link:hover .link-actions { visibility: visible; opacity: 1; }
        .link-actions { visibility: hidden; opacity: 0; transition: opacity 0.2s; }

        /* General Modal Styling */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen flex flex-col items-center justify-center p-4">
        <!-- Main application content will render here -->
        <div id="initial-loading" class="text-gray-500 text-lg">Loading application...</div>
    </div>
    
    <!-- Modal Container for editing/confirmation -->
    <div id="modal-container"></div>

    <script>
        // --- 1. CONFIGURATION ---
        const SUPABASE_URL = 'https://ialszdegiwiderrpxuue.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhbHN6ZGVnaXdpZGVycnB4dXVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NjEyMzksImV4cCI6MjA4MDMzNzIzOX0.45KoySJoI3rMGgXYTiYdDWMCPoYOkFBWRDsxaQeRwHU'; 
        const USER_EMAIL = 'aayushbaral.abb@gmail.com';
        const STORAGE_BUCKET = 'personal-documents';
        
        // New file upload limit: 50 MB
        const MAX_FILE_SIZE_MB = 50; 
        const MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024;
        
        // Key used to store session data in browser storage (used for cleanup)
        const SUPABASE_STORAGE_KEY = 'supabase-session-aayush'; 

        // Global variables for Supabase client
        let supabase;

        // --- 2. STATE MANAGEMENT ---
        let isAuthenticated = false;
        let userId = null;
        let currentView = 'links-view';
        let links = [];
        let memos = [];
        let documents = [];

        // --- 3. CORE UTILITIES ---

        // Helper to display messages to the user
        const displayMessage = (message, type = 'success') => {
            const container = document.getElementById('app');
            const color = type === 'error' ? 'bg-red-500' : 'bg-green-500';
            const messageEl = document.createElement('div');
            messageEl.className = `fixed top-4 right-4 p-4 rounded-lg text-white shadow-xl ${color} z-50 transition-opacity duration-300`;
            messageEl.textContent = message;
            container.appendChild(messageEl);
            setTimeout(() => {
                messageEl.style.opacity = '0';
                setTimeout(() => messageEl.remove(), 300);
            }, 3000);
        };

        // Modal Handlers (Used for confirmation and editing)
        const showModal = (contentHTML) => {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `
                <div class="modal" id="my-modal">
                    <div class="modal-content">
                        ${contentHTML}
                    </div>
                </div>
            `;
            // Attach close handler
            document.getElementById('my-modal').addEventListener('click', (e) => {
                if (e.target.id === 'my-modal') {
                    closeModal();
                }
            });
        };

        const closeModal = () => {
            document.getElementById('modal-container').innerHTML = '';
        };
        
        // Utility to check if a file can be viewed inline in the browser
        const isFileViewable = (filename) => {
            const viewableExtensions = ['.pdf', '.jpg', '.jpeg', '.png', '.gif', '.svg'];
            const lowerFilename = filename.toLowerCase();
            return viewableExtensions.some(ext => lowerFilename.endsWith(ext));
        };
        
        // Utility to split filename into base name and extension
        const getBaseNameAndExtension = (filename) => {
            const lastDot = filename.lastIndexOf('.');
            if (lastDot <= 0) { // Handle files without a dot or dot is the first character
                return { baseName: filename, extension: '' };
            }
            return {
                baseName: filename.substring(0, lastDot),
                extension: filename.substring(lastDot)
            };
        };


        // --- 4. DATA HANDLING (Postgres/Storage) ---

        const fetchData = async () => {
            if (!userId || !supabase) return;

            // 1. Fetch Links
            const { data: linksData, error: linksError } = await supabase
                .from('links')
                .select('*')
                .eq('user_id', userId)
                .order('id', { ascending: false });

            if (linksError) { console.error("Error fetching links:", linksError); } else { links = linksData || []; }

            // 2. Fetch Memos
            const { data: memosData, error: memosError } = await supabase
                .from('memos')
                .select('*')
                .eq('user_id', userId)
                .order('id', { ascending: false });

            if (memosError) { console.error("Error fetching memos:", memosError); } else { memos = memosData || []; }

            // 3. Fetch Documents (from Storage)
            const { data: documentsData, error: documentsError } = await supabase.storage
                .from(STORAGE_BUCKET)
                .list(userId + '/', { limit: 100, sortBy: { column: 'created_at', order: 'desc' } });
            
            if (documentsError && documentsError.statusCode !== '404') {
                console.error("Error fetching documents:", documentsError);
            } else {
                documents = documentsData
                    ? documentsData.filter(f => f.name !== '.emptyFolderPlaceholder')
                    : [];
            }
            
            render();
        };

        // --- LINKS CRUD ---

        const openLink = (url, e) => {
             // Prevent opening the link if the click originated from an action button (edit/delete)
            if (e.target.closest('.link-actions')) return; 
            window.open(url, '_blank').focus();
        };
        
        const addLink = async (title, url) => {
            if (!userId || !supabase) return;
            const { error } = await supabase
                .from('links')
                .insert({ user_id: userId, title: title, url: url });
            
            if (error) {
                displayMessage(`Failed to add link: ${error.message}`, 'error');
            } else {
                displayMessage("Link added successfully!");
                document.getElementById('add-link-form').reset();
                await fetchData();
            }
        };

        const updateLink = async (id, title, url) => {
            if (!userId || !supabase) return;
            const { error } = await supabase
                .from('links')
                .update({ title: title, url: url })
                .eq('id', id)
                .eq('user_id', userId);

            if (error) {
                displayMessage(`Failed to update link: ${error.message}`, 'error');
            } else {
                displayMessage("Link updated successfully!");
                closeModal();
                await fetchData();
            }
        };
        
        const deleteLink = async (id) => {
            if (!userId || !supabase) return;
            const { error } = await supabase
                .from('links')
                .delete()
                .eq('id', id)
                .eq('user_id', userId);

            if (error) {
                displayMessage(`Failed to delete link: ${error.message}`, 'error');
            } else {
                displayMessage("Link deleted successfully!");
                closeModal();
                await fetchData();
            }
        };

        // --- MEMOS CRUD ---
        
        const addMemo = async (content) => {
            if (!userId || !supabase) return;
            const { error } = await supabase
                .from('memos')
                .insert({ user_id: userId, content: content });
            
            if (error) {
                displayMessage(`Failed to save memo: ${error.message}`, 'error');
            } else {
                displayMessage("Memo saved successfully!");
                document.getElementById('add-memo-textarea').value = '';
                await fetchData();
            }
        };

        const updateMemo = async (id, content) => {
             if (!userId || !supabase) return;
            const { error } = await supabase
                .from('memos')
                .update({ content: content })
                .eq('id', id)
                .eq('user_id', userId);

            if (error) {
                displayMessage(`Failed to update memo: ${error.message}`, 'error');
            } else {
                displayMessage("Memo updated successfully!");
                closeModal();
                await fetchData();
            }
        };
        
        const deleteMemo = async (id) => {
            if (!userId || !supabase) return;
            const { error } = await supabase
                .from('memos')
                .delete()
                .eq('id', id)
                .eq('user_id', userId);

            if (error) {
                displayMessage(`Failed to delete memo: ${error.message}`, 'error');
            } else {
                displayMessage("Memo deleted successfully!");
                closeModal();
                await fetchData();
            }
        };

        // --- DOCUMENTS CRUD ---

        const uploadDocument = async (file) => {
            if (!userId || !supabase) return;

            // Check file size limit
            if (file.size > MAX_FILE_SIZE_BYTES) {
                return displayMessage(`File size exceeds the ${MAX_FILE_SIZE_MB}MB limit.`, 'error');
            }

            const uploadButton = document.querySelector('#document-upload-form button[type="submit"]');
            const originalText = uploadButton.textContent;
            uploadButton.textContent = 'Uploading...';
            uploadButton.disabled = true;

            const filePath = `${userId}/${file.name}`;
            
            const { error } = await supabase.storage
                .from(STORAGE_BUCKET)
                .upload(filePath, file);
                
            uploadButton.textContent = originalText;
            uploadButton.disabled = false;

            if (error) {
                displayMessage(`Upload failed: ${error.message}`, 'error');
            } else {
                displayMessage("Document uploaded successfully!");
                document.getElementById('document-file').value = ''; // Clear input
                await fetchData();
            }
        };

        const deleteDocument = async (filename) => {
            if (!userId || !supabase) return;
            const filePath = `${userId}/${filename}`;

            const { error } = await supabase.storage
                .from(STORAGE_BUCKET)
                .remove([filePath]);

            if (error) {
                displayMessage(`Failed to delete document: ${error.message}`, 'error');
            } else {
                displayMessage("Document deleted successfully!");
                closeModal();
                await fetchData();
            }
        };

        const renameDocument = async (oldFilename, newFilename) => {
            if (!userId || !supabase) return;

            // Basic validation
            if (oldFilename === newFilename) {
                closeModal();
                return displayMessage("Filenames are the same. No change needed.", 'error');
            }
            if (newFilename.length > 255) {
                return displayMessage("Filename is too long.", 'error');
            }
            
            const oldPath = `${userId}/${oldFilename}`;
            const newPath = `${userId}/${newFilename}`;

            const { error } = await supabase.storage
                .from(STORAGE_BUCKET)
                .move(oldPath, newPath);

            if (error) {
                displayMessage(`Rename failed: ${error.message}`, 'error');
            } else {
                displayMessage(`Document renamed to ${newFilename} successfully!`);
                closeModal();
                await fetchData();
            }
        };

        const downloadDocument = async (filename) => {
             if (!userId || !supabase) return;
             const filePath = `${userId}/${filename}`;
             
             const { data, error } = await supabase.storage
                 .from(STORAGE_BUCKET)
                 .download(filePath);
             
             if (error) {
                 displayMessage(`Download failed: ${error.message}`, 'error');
             } else {
                 const url = URL.createObjectURL(data);
                 const a = document.createElement('a');
                 a.href = url;
                 a.download = filename;
                 document.body.appendChild(a);
                 a.click();
                 document.body.removeChild(a);
                 URL.revokeObjectURL(url);
             }
        }
        
        const viewDocument = async (filename) => {
             if (!userId || !supabase) return;
             const filePath = `${userId}/${filename}`;
             
             // Create a temporary signed URL (valid for 60 seconds)
             const { data, error } = await supabase.storage
                 .from(STORAGE_BUCKET)
                 .createSignedUrl(filePath, 60); // 60 seconds validity
             
             if (error) {
                 displayMessage(`Failed to create view link: ${error.message}`, 'error');
             } else if (data && data.signedUrl) {
                 // Open the signed URL in a new tab for direct browser viewing
                 window.open(data.signedUrl, '_blank').focus();
             } else {
                 displayMessage("Could not generate a direct viewing link.", 'error');
             }
        }

        // --- 5. AUTHENTICATION LOGIC ---

        const handleLogin = async (e) => {
            e.preventDefault();
            
            if (!supabase) return displayMessage("Application is not initialized.", 'error');

            const passwordInput = document.getElementById('password');
            const password = passwordInput.value;
            const loginButton = document.querySelector('#login-form button[type="submit"]');
            loginButton.textContent = 'Logging In...';
            loginButton.disabled = true;

            const { data, error } = await supabase.auth.signInWithPassword({
                email: USER_EMAIL,
                password: password,
            });
            
            loginButton.textContent = 'Log In';
            loginButton.disabled = false;

            if (error) {
                // IMPORTANT: Clear the password field on failure for security
                passwordInput.value = ''; 
                displayMessage(`Login failed: ${error.message}`, 'error');
            } else if (data.user) {
                isAuthenticated = true;
                userId = data.user.id;
                displayMessage("Welcome back to your hub!");
                await fetchData();
                render();
            }
        };

        const handleLogout = async () => {
            if (!supabase) return;
            
            // 1. Sign out from Supabase (clears in-memory session)
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error("Logout error:", error);
            }
            
            // 2. Explicitly remove the session key from browser storage for redundancy
            localStorage.removeItem(SUPABASE_STORAGE_KEY);
            // Clear all data (password input, temporary links in state, etc.)
            links = [];
            memos = [];
            documents = [];

            // 3. Reset application state
            isAuthenticated = false;
            userId = null;
            displayMessage("Logged out successfully. Session data cleared.");
            render();
            
            // Clear password field if it exists after signout (for extra security)
            const passwordInput = document.getElementById('password');
            if (passwordInput) {
                passwordInput.value = '';
            }
        };

        // --- 6. RENDERING FUNCTIONS (JSX-like HTML strings) ---

        const renderLogin = () => {
            return `
                <div class="card p-8 rounded-xl w-full max-w-md">
                    <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Private Portal Login</h1>
                    <form id="login-form" class="space-y-4">
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="email" name="email" value="${USER_EMAIL}" readonly
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 cursor-not-allowed focus:outline-none">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                            <!-- Password field will be cleared on logout/failed login -->
                            <input type="password" id="password" name="password" required
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                        <button type="submit"
                            class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition duration-150">
                            Log In
                        </button>
                    </form>
                </div>
            `;
        };

        const renderLinkView = () => `
            <div class="space-y-4 w-full">
                <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">Saved Links (${links.length})</h2>
                ${links.length === 0 
                    ? '<p class="text-gray-500 italic p-4 bg-gray-50 rounded-lg">No links saved yet. Add one in the "+ Add Link" section.</p>' 
                    : links.map(link => `
                        <!-- Card now uses bg-gray-100 for visual separation -->
                        <div class="p-4 card rounded-lg transition duration-150 border border-gray-300 editable-link cursor-pointer hover:shadow-lg bg-gray-100" 
                             onclick="openLink('${link.url}', event)">
                            <div class="block">
                                <p class="font-semibold text-blue-600 text-lg truncate">${link.title}</p>
                                <p class="text-sm text-gray-500 truncate mt-1">${link.url}</p>
                            </div>
                            <!-- Added onclick="event.stopPropagation()" to prevent card click from triggering when clicking buttons -->
                            <div class="link-actions mt-2 flex justify-end space-x-2" onclick="event.stopPropagation()">
                                <button data-id="${link.id}" data-title="${link.title}" data-url="${link.url}" 
                                    class="edit-link-btn text-sm text-yellow-600 hover:text-yellow-800 font-medium transition duration-150">
                                    Edit
                                </button>
                                <button data-id="${link.id}" 
                                    class="delete-link-btn text-sm text-red-600 hover:text-red-800 font-medium transition duration-150">
                                    Delete
                                </button>
                            </div>
                        </div>
                    `).join('')
                }
            </div>
        `;

        const renderAddLink = () => `
            <div class="card p-6 rounded-xl w-full max-w-lg">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Add New Link</h2>
                <form id="add-link-form" class="space-y-4">
                    <div>
                        <label for="link-title" class="block text-sm font-medium text-gray-700">Title (e.g., Supabase Docs)</label>
                        <input type="text" id="link-title" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div>
                        <label for="link-url" class="block text-sm font-medium text-gray-700">URL (Must start with http:// or https://)</label>
                        <input type="url" id="link-url" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-green-600 hover:bg-green-700 transition duration-150">
                        üíæ Save Link
                    </button>
                </form>
            </div>
        `;

        const renderDocumentSection = () => `
            <div class="space-y-6 w-full max-w-2xl">
                <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">Document Manager (${documents.length})</h2>
                
                <!-- Upload Form -->
                <div class="card p-6 rounded-xl">
                    <form id="document-upload-form" class="space-y-4">
                        <label for="document-file" class="block text-sm font-medium text-gray-700">
                            Upload New File (Max ${MAX_FILE_SIZE_MB}MB)
                        </label>
                        <input type="file" id="document-file" required class="mt-1 block w-full">
                        <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-green-600 hover:bg-green-700 transition duration-150">
                            ‚¨ÜÔ∏è Upload Document
                        </button>
                    </form>
                </div>

                <!-- Document List -->
                <div class="space-y-3">
                    ${documents.length === 0 
                        ? '<p class="text-gray-500 italic p-4 bg-gray-50 rounded-lg">No documents uploaded yet.</p>' 
                        : documents.map(doc => `
                            <div class="p-3 card rounded-lg flex justify-between items-center bg-gray-50 border border-gray-100">
                                <span class="font-medium text-gray-800 truncate">${doc.name}</span>
                                <div class="flex space-x-3 items-center">
                                    <span class="text-xs text-gray-400">${(doc.metadata.size / 1024 / 1024).toFixed(2)} MB</span>
                                    
                                    ${isFileViewable(doc.name) ? `
                                        <button data-filename="${doc.name}" 
                                            class="view-document-btn text-sm text-emerald-600 hover:text-emerald-800 font-medium transition duration-150 focus:outline-none">
                                            üëÅÔ∏è View
                                        </button>
                                    ` : ''}

                                    <button data-filename="${doc.name}" 
                                        class="rename-document-btn text-sm text-yellow-600 hover:text-yellow-800 font-medium transition duration-150 focus:outline-none">
                                        ‚úèÔ∏è Rename
                                    </button>

                                    <button data-filename="${doc.name}" 
                                        class="download-btn text-sm text-blue-600 hover:text-blue-800 font-medium transition duration-150 focus:outline-none">
                                        ‚¨áÔ∏è Download
                                    </button>
                                    <button data-filename="${doc.name}" 
                                        class="delete-document-btn text-sm text-red-600 hover:text-red-800 font-medium transition duration-150 focus:outline-none">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            </div>
                        `).join('')
                    }
                </div>
            </div>
        `;

        const renderMemoSection = () => `
            <div class="space-y-6 w-full max-w-xl">
                <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">Personal Memo Pad</h2>
                
                <!-- Add Memo -->
                <div class="card p-6 rounded-xl">
                    <h3 class="text-lg font-medium mb-3 text-gray-700">Save a New Memo</h3>
                    <textarea id="add-memo-textarea" rows="8" placeholder="Type your private notes, ideas, or brain dumps here..." 
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 resize-none"></textarea>
                    
                    <button id="save-memo-btn" type="button" class="w-full mt-3 py-2 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-green-600 hover:bg-green-700 transition duration-150">
                        üìù Save Memo
                    </button>
                </div>

                <!-- View Memos -->
                <h3 class="text-lg font-medium text-gray-700">Past Memos (${memos.length})</h3>
                <div class="space-y-3 memo-scroll">
                    ${memos.length === 0 
                        ? '<p class="text-gray-500 italic p-4 bg-gray-50 rounded-lg">No memos saved yet.</p>' 
                        : memos.map(memo => `
                            <div class="p-4 card rounded-lg bg-gray-50 border border-gray-100">
                                <p class="whitespace-pre-wrap text-gray-700">${memo.content}</p>
                                <div class="flex justify-between items-center mt-2">
                                    <p class="text-xs text-gray-400">Saved: ${new Date(memo.created_at).toLocaleString()}</p>
                                    <div class="flex space-x-2">
                                        <button data-id="${memo.id}" data-content="${memo.content.replace(/"/g, '&quot;')}"
                                            class="edit-memo-btn text-sm text-yellow-600 hover:text-yellow-800 font-medium transition duration-150">
                                            Edit
                                        </button>
                                        <button data-id="${memo.id}" 
                                            class="delete-memo-btn text-sm text-red-600 hover:text-red-800 font-medium transition duration-150">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')
                    }
                </div>
            </div>
        `;

        const renderAuthenticatedApp = () => {
            let content;
            switch (currentView) {
                case 'links-view': content = renderLinkView(); break;
                case 'add-link': content = renderAddLink(); break;
                case 'document': content = renderDocumentSection(); break;
                case 'memo': content = renderMemoSection(); break;
                default: content = renderLinkView(); break;
            }

            return `
                <div class="w-full max-w-5xl">
                    <!-- Header/Nav Bar -->
                    <header class="card p-4 rounded-xl flex flex-col sm:flex-row justify-between items-center mb-6 bg-white shadow-lg">
                        <div class="text-xl font-extrabold text-emerald-600 mb-2 sm:mb-0">AAYUSH'S PRIVATE HUB</div>
                        <div class="flex space-x-2 sm:space-x-4 overflow-x-auto pb-1">
                            <button onclick="setCurrentView('links-view')" class="nav-btn py-2 px-3 sm:px-4 font-medium text-sm sm:text-base text-gray-700 whitespace-nowrap hover:text-emerald-600 transition duration-150 ${currentView === 'links-view' ? 'active' : ''}">Link View</button>
                            <button onclick="setCurrentView('add-link')" class="nav-btn py-2 px-3 sm:px-4 font-medium text-sm sm:text-base text-gray-700 whitespace-nowrap hover:text-emerald-600 transition duration-150 ${currentView === 'add-link' ? 'active' : ''}">+ Add Link</button>
                            <button onclick="setCurrentView('document')" class="nav-btn py-2 px-3 sm:px-4 font-medium text-sm sm:text-base text-gray-700 whitespace-nowrap hover:text-emerald-600 transition duration-150 ${currentView === 'document' ? 'active' : ''}">Document</button>
                            <button onclick="setCurrentView('memo')" class="nav-btn py-2 px-3 sm:px-4 font-medium text-sm sm:text-base text-gray-700 whitespace-nowrap hover:text-emerald-600 transition duration-150 ${currentView === 'memo' ? 'active' : ''}">Memo</button>
                        </div>
                        <button id="logout-btn" class="mt-4 sm:mt-0 py-2 px-4 bg-red-500 text-white text-sm font-medium rounded-lg shadow-md hover:bg-red-600 transition duration-150">
                            üö™ Logout/Close
                        </button>
                    </header>

                    <!-- Content Area -->
                    <div id="content-area" class="card p-6 rounded-xl min-h-[60vh] flex justify-center items-start pt-8">
                        ${content}
                    </div>
                </div>
            `;
        };

        const render = () => {
            const app = document.getElementById('app');
            // Remove initial loading message once rendering starts
            const initialLoading = document.getElementById('initial-loading');
            if(initialLoading) initialLoading.remove();
            
            app.innerHTML = isAuthenticated ? renderAuthenticatedApp() : renderLogin();
            attachEventListeners();
        };

        const setCurrentView = (view) => {
            currentView = view;
            render();
            // Fetch data again if switching to a data-intensive view
            if (['links-view', 'document', 'memo'].includes(view)) {
                fetchData(); 
            }
        };

        // --- 7. EVENT LISTENERS ---
        
        // --- MODAL GENERATORS ---

        const showEditLinkModal = (id, title, url) => {
            const content = `
                <h2 class="text-xl font-bold mb-4 text-gray-800">Edit Link</h2>
                <form id="edit-link-form" class="space-y-4">
                    <input type="hidden" id="edit-link-id" value="${id}">
                    <div>
                        <label for="edit-link-title" class="block text-sm font-medium text-gray-700">Title</label>
                        <input type="text" id="edit-link-title" required value="${title}"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div>
                        <label for="edit-link-url" class="block text-sm font-medium text-gray-700">URL</label>
                        <input type="url" id="edit-link-url" required value="${url}"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeModal()" 
                            class="py-2 px-4 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 transition duration-150">
                            Cancel
                        </button>
                        <button type="submit" 
                            class="py-2 px-4 border border-transparent rounded-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition duration-150">
                            Save Changes
                        </button>
                    </div>
                </form>
            `;
            showModal(content);
            document.getElementById('edit-link-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const newTitle = document.getElementById('edit-link-title').value.trim();
                const newUrl = document.getElementById('edit-link-url').value.trim();
                const linkId = document.getElementById('edit-link-id').value;
                if (newTitle && newUrl) updateLink(linkId, newTitle, newUrl);
            });
        };

        const showDeleteConfirmationModal = (itemType, itemId, itemName) => {
            const content = `
                <h2 class="text-xl font-bold mb-4 text-red-600">Confirm Deletion</h2>
                <p class="text-gray-700 mb-6">Are you sure you want to permanently delete this ${itemType}?</p>
                <p class="font-semibold text-gray-800 break-words mb-6">Name: ${itemName}</p>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal()" 
                        class="py-2 px-4 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 transition duration-150">
                        Cancel
                    </button>
                    <button id="confirm-delete-btn" type="button" 
                        class="py-2 px-4 border border-transparent rounded-md text-sm font-medium text-white bg-red-600 hover:bg-red-700 transition duration-150">
                        Yes, Delete
                    </button>
                </div>
            `;
            showModal(content);
            
            document.getElementById('confirm-delete-btn').addEventListener('click', () => {
                if (itemType === 'link') deleteLink(itemId);
                else if (itemType === 'memo') deleteMemo(itemId);
                else if (itemType === 'document') deleteDocument(itemName);
            });
        };

        const showEditMemoModal = (id, content) => {
            const contentHTML = `
                <h2 class="text-xl font-bold mb-4 text-gray-800">Edit Memo</h2>
                <form id="edit-memo-form" class="space-y-4">
                    <input type="hidden" id="edit-memo-id" value="${id}">
                    <div>
                        <label for="edit-memo-content" class="block text-sm font-medium text-gray-700">Memo Content</label>
                        <textarea id="edit-memo-content" rows="10" required 
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500 resize-none">${content}</textarea>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeModal()" 
                            class="py-2 px-4 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 transition duration-150">
                            Cancel
                        </button>
                        <button type="submit" 
                            class="py-2 px-4 border border-transparent rounded-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition duration-150">
                            Save Changes
                        </button>
                    </div>
                </form>
            `;
            showModal(contentHTML);
            document.getElementById('edit-memo-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const newContent = document.getElementById('edit-memo-content').value.trim();
                const memoId = document.getElementById('edit-memo-id').value;
                if (newContent) updateMemo(memoId, newContent);
            });
        };

        const showRenameDocumentModal = (oldFilename) => {
            const { baseName, extension } = getBaseNameAndExtension(oldFilename);
            
            const content = `
                <h2 class="text-xl font-bold mb-4 text-gray-800">Rename Document</h2>
                <p class="text-sm text-gray-500 mb-4">The file extension (${extension}) will be preserved automatically.</p>
                <form id="rename-document-form" class="space-y-4">
                    <input type="hidden" id="old-filename" value="${oldFilename}">
                    <input type="hidden" id="file-extension" value="${extension}">
                    <div>
                        <label for="new-basename" class="block text-sm font-medium text-gray-700">New File Name</label>
                        <div class="flex items-center space-x-2 mt-1">
                            <input type="text" id="new-basename" required value="${baseName}"
                                class="block w-full px-3 py-2 border border-gray-300 rounded-l-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                            <!-- Display extension as read-only label -->
                            <span class="px-3 py-2 bg-gray-100 border border-gray-300 rounded-r-md text-gray-600 font-mono flex-shrink-0">${extension}</span>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeModal()" 
                            class="py-2 px-4 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 transition duration-150">
                            Cancel
                        </button>
                        <button type="submit" 
                            class="py-2 px-4 border border-transparent rounded-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition duration-150">
                            Rename
                        </button>
                    </div>
                </form>
            `;
            showModal(content);
            document.getElementById('rename-document-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const newBaseName = document.getElementById('new-basename').value.trim();
                const extension = document.getElementById('file-extension').value;
                const oldName = document.getElementById('old-filename').value;
                
                // Reconstruct the new full filename by preserving the original extension
                const newFilename = newBaseName + extension;

                if (newBaseName) renameDocument(oldName, newFilename);
            });
        };


        const attachEventListeners = () => {
            if (!isAuthenticated) {
                const form = document.getElementById('login-form');
                if (form) form.addEventListener('submit', handleLogin);
            } else {
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);

                if (currentView === 'add-link') {
                    const form = document.getElementById('add-link-form');
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const title = document.getElementById('link-title').value.trim();
                        const url = document.getElementById('link-url').value.trim();
                        if (title && url) addLink(title, url);
                        else displayMessage("Title and URL cannot be empty.", 'error');
                    });
                } 
                
                else if (currentView === 'links-view') {
                    // Attach edit link listeners
                    document.querySelectorAll('.edit-link-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const id = e.target.getAttribute('data-id');
                            const title = e.target.getAttribute('data-title');
                            const url = e.target.getAttribute('data-url');
                            showEditLinkModal(id, title, url);
                        });
                    });

                    // Attach delete link listeners
                    document.querySelectorAll('.delete-link-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const id = e.target.getAttribute('data-id');
                            const parent = e.target.closest('.editable-link');
                            const title = parent.querySelector('.font-semibold').textContent;
                            showDeleteConfirmationModal('link', id, title);
                        });
                    });
                }
                
                else if (currentView === 'memo') {
                    const saveBtn = document.getElementById('save-memo-btn');
                    const memoTextarea = document.getElementById('add-memo-textarea');

                    // Save Memo functionality
                    saveBtn.addEventListener('click', () => {
                        const content = memoTextarea.value;
                        if (content.trim()) addMemo(content.trim());
                        else displayMessage("Memo content cannot be empty.", 'error');
                    });
                    
                    // Attach edit memo listeners
                    document.querySelectorAll('.edit-memo-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const id = e.target.getAttribute('data-id');
                            // Replace HTML entity for quote back to standard quote for the textarea
                            const content = e.target.getAttribute('data-content').replace(/&quot;/g, '"');
                            showEditMemoModal(id, content);
                        });
                    });
                    
                    // Attach delete memo listeners
                    document.querySelectorAll('.delete-memo-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const id = e.target.getAttribute('data-id');
                            const parent = e.target.closest('.card');
                            // Use first 50 chars as the name for confirmation
                            const contentSnippet = parent.querySelector('.whitespace-pre-wrap').textContent.substring(0, 50) + '...';
                            showDeleteConfirmationModal('memo', id, contentSnippet);
                        });
                    });


                } 
                
                else if (currentView === 'document') {
                    const uploadForm = document.getElementById('document-upload-form');
                    uploadForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const fileInput = document.getElementById('document-file');
                        if (fileInput.files.length > 0) {
                            uploadDocument(fileInput.files[0]);
                        } else {
                            displayMessage("Please select a file to upload.", 'error');
                        }
                    });
                    
                    // Attach download document listeners
                    document.querySelectorAll('.download-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const filename = e.target.getAttribute('data-filename');
                            downloadDocument(filename);
                        });
                    });

                    // Attach view document listeners
                    document.querySelectorAll('.view-document-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const filename = e.target.getAttribute('data-filename');
                            viewDocument(filename);
                        });
                    });


                    // Attach delete document listeners
                    document.querySelectorAll('.delete-document-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const filename = e.target.getAttribute('data-filename');
                            showDeleteConfirmationModal('document', null, filename); // itemId is null for document as we use filename
                        });
                    });

                    // Attach rename document listeners
                    document.querySelectorAll('.rename-document-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const filename = e.target.getAttribute('data-filename');
                            showRenameDocumentModal(filename);
                        });
                    });
                }
            }
        };

        // --- 8. INITIALIZATION (Runs after all assets are loaded) ---

        const createSupabaseClient = () => {
            if (typeof window.supabase === 'undefined' || !window.supabase.createClient) {
                 console.error("Supabase SDK not loaded.");
                 return null;
            }
            
            // Check for configuration before creating the client
            if (SUPABASE_URL.includes('YOUR_SUPABASE_URL') || SUPABASE_ANON_KEY.includes('YOUR_SUPABASE_ANON_KEY')) {
                displayMessage("Configuration Error: Please update SUPABASE_URL and SUPABASE_ANON_KEY in the code.", 'error');
                return null;
            }

            return window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                 auth: {
                    // Ensures the session is only in memory and cleared on refresh/close
                    storageKey: SUPABASE_STORAGE_KEY, 
                    persistSession: false // Critical for clearing data on refresh/close
                 }
            });
        }
        
        const init = () => {
            // 1. Initialize Supabase client
            supabase = createSupabaseClient();
            
            // 2. Initial render
            isAuthenticated = false;
            userId = null;
            render();
            
            // Ensure password field is cleared on initial load/refresh for security
            const passwordInput = document.getElementById('password');
            if (passwordInput) {
                passwordInput.value = '';
            }
        };

        // Ensure init runs only after the DOM and all resources (including Supabase SDK) are loaded.
        window.onload = init;

    </script>
</body>
</html>